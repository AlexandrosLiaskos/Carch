name: CI

on:
  push:
    branches: [ main, develop ]
  pull_request:
    branches: [ main, develop ]

jobs:
  build-and-test-linux:
    name: Build and Test (Linux)
    runs-on: ubuntu-latest
    strategy:
      matrix:
        compiler: [gcc, clang]
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v3
    
    - name: Get current date
      id: date
      run: echo "::set-output name=date::$(date +'%Y-%m-%d')"
    
    - name: Cache build
      uses: actions/cache@v3
      with:
        path: build
        key: build-linux-${{ matrix.compiler }}-${{ steps.date.outputs.date }}-${{ github.sha }}
        restore-keys: |
          build-linux-${{ matrix.compiler }}-${{ steps.date.outputs.date }}-
          build-linux-${{ matrix.compiler }}-
    
    - name: Setup GCC
      if: matrix.compiler == 'gcc'
      run: |
        sudo apt-get update
        sudo apt-get install -y g++
    
    - name: Setup Clang
      if: matrix.compiler == 'clang'
      run: |
        sudo apt-get update
        sudo apt-get install -y clang
    
    - name: Setup CMake
      uses: jwlawson/actions-setup-cmake@v1.13
      with:
        cmake-version: '3.20.x'
    
    - name: Configure CMake
      run: |
        if [ "${{ matrix.compiler }}" == "gcc" ]; then
          export CC=gcc
          export CXX=g++
        else
          export CC=clang
          export CXX=clang++
        fi
        cmake -B build -DCMAKE_BUILD_TYPE=Release -DBUILD_TESTS=ON -DBUILD_BENCHMARKS=OFF
    
    - name: Build
      run: cmake --build build --config Release -j$(nproc)
    
    - name: Run Tests
      working-directory: build
      run: ctest --rerun-failed --output-on-failure --verbose
    
    - name: Upload Test Executables
      if: failure()
      uses: actions/upload-artifact@v4
      with:
        name: test-executables-linux-${{ matrix.compiler }}
        path: |
          build/stress_tests
          build/edge_case_tests
          build/error_message_tests
    
    - name: Upload Test Results
      if: always()
      uses: actions/upload-artifact@v4
      with:
        name: test-results-linux-${{ matrix.compiler }}
        path: build/Testing/Temporary/LastTest.log

  build-and-test-windows:
    name: Build and Test (Windows)
    runs-on: windows-latest
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v3
    
    - name: Get current date
      id: date
      run: echo "::set-output name=date::$(date +'%Y-%m-%d')"
    
    - name: Cache build
      uses: actions/cache@v3
      with:
        path: build
        key: build-windows-${{ steps.date.outputs.date }}-${{ github.sha }}
        restore-keys: |
          build-windows-${{ steps.date.outputs.date }}-
          build-windows-
    
    - name: Setup CMake
      uses: jwlawson/actions-setup-cmake@v1.13
      with:
        cmake-version: '3.20.x'
    
    - name: Configure CMake
      run: cmake -B build -DCMAKE_BUILD_TYPE=Release -DBUILD_TESTS=ON -DBUILD_BENCHMARKS=OFF
    
    - name: Build
      run: cmake --build build --config Release
    
    - name: Run Tests
      working-directory: build
      run: ctest --rerun-failed --output-on-failure --verbose -C Release
    
    - name: Upload Test Executables
      if: failure()
      uses: actions/upload-artifact@v4
      with:
        name: test-executables-windows
        path: |
          build/stress_tests
          build/edge_case_tests
          build/error_message_tests
    
    - name: Upload Test Results
      if: always()
      uses: actions/upload-artifact@v4
      with:
        name: test-results-windows
        path: build/Testing/Temporary/LastTest.log

  build-and-test-macos:
    name: Build and Test (macOS)
    runs-on: macos-latest
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v3
    
    - name: Get current date
      id: date
      run: echo "::set-output name=date::$(date +'%Y-%m-%d')"
    
    - name: Cache build
      uses: actions/cache@v3
      with:
        path: build
        key: build-macos-${{ steps.date.outputs.date }}-${{ github.sha }}
        restore-keys: |
          build-macos-${{ steps.date.outputs.date }}-
          build-macos-
    
    - name: Setup CMake
      uses: jwlawson/actions-setup-cmake@v1.13
      with:
        cmake-version: '3.20.x'
    
    - name: Configure CMake
      run: cmake -B build -DCMAKE_BUILD_TYPE=Release -DBUILD_TESTS=ON -DBUILD_BENCHMARKS=OFF
    
    - name: Build
      run: cmake --build build --config Release -j$(sysctl -n hw.ncpu)
    
    - name: Run Tests
      working-directory: build
      run: ctest --rerun-failed --output-on-failure --verbose
    
    - name: Upload Test Executables
      if: failure()
      uses: actions/upload-artifact@v4
      with:
        name: test-executables-macos
        path: |
          build/stress_tests
          build/edge_case_tests
          build/error_message_tests
    
    - name: Upload Test Results
      if: always()
      uses: actions/upload-artifact@v4
      with:
        name: test-results-macos
        path: build/Testing/Temporary/LastTest.log

  code-coverage:
    name: Code Coverage
    runs-on: ubuntu-latest
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v3
    
    - name: Install dependencies
      run: |
        sudo apt-get update
        sudo apt-get install -y g++ lcov
    
    - name: Setup CMake
      uses: jwlawson/actions-setup-cmake@v1.13
      with:
        cmake-version: '3.20.x'
    
    - name: Configure with coverage
      run: |
        cmake -B build \
          -DCMAKE_BUILD_TYPE=Debug \
          -DCMAKE_CXX_FLAGS="--coverage -fprofile-arcs -ftest-coverage" \
          -DCMAKE_EXE_LINKER_FLAGS="--coverage" \
          -DBUILD_TESTS=ON
    
    - name: Build
      run: cmake --build build -j$(nproc)
    
    - name: Run Tests
      working-directory: build
      run: ctest --rerun-failed --output-on-failure
    
    - name: Generate coverage report
      run: |
        lcov --directory build --capture --output-file coverage.info
        lcov --remove coverage.info '/usr/*' --output-file coverage.info
        lcov --list coverage.info
    
    - name: Upload coverage to Codecov
      uses: codecov/codecov-action@v3
      with:
        files: ./coverage.info
        fail_ci_if_error: false

  static-analysis:
    name: Static Analysis
    runs-on: ubuntu-latest
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v3
    
    - name: Install clang-tidy
      run: |
        sudo apt-get update
        sudo apt-get install -y clang-tidy
    
    - name: Setup CMake
      uses: jwlawson/actions-setup-cmake@v1.13
      with:
        cmake-version: '3.20.x'
    
    - name: Configure CMake
      run: cmake -B build -DCMAKE_EXPORT_COMPILE_COMMANDS=ON
    
    - name: Run clang-tidy
      run: |
        clang-tidy --version
        find src -name '*.cpp' | xargs clang-tidy -p build || true